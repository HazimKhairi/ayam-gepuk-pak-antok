// Prisma Schema for Ramadhan Reservation System
// Database: MySQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Outlet model - stores 6 restaurant locations
model Outlet {
  id              String   @id @default(uuid())
  name            String   @db.VarChar(100)
  address         String   @db.VarChar(255)
  phone           String   @db.VarChar(20)
  googleMapsUrl   String?  @db.VarChar(500)
  openTime        String   @default("10:00") @db.VarChar(10)
  closeTime       String   @default("17:00") @db.VarChar(10)
  isActive        Boolean  @default(true)
  deliveryFee     Decimal  @default(0) @db.Decimal(10, 2)
  maxCapacity     Int      @default(100)
  deliveryEnabled Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tables    Table[]
  timeSlots TimeSlot[]
  orders    Order[]
  admins    Admin[]

  @@map("outlets")
}

// Table model - restaurant tables per outlet
model Table {
  id       String      @id @default(uuid())
  outletId String
  tableNo  String      @db.VarChar(10)
  capacity Int         @default(4)
  zone     String      @default("Regular") @db.VarChar(50)
  status   TableStatus @default(AVAILABLE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  outlet Outlet  @relation(fields: [outletId], references: [id], onDelete: Cascade)
  orders Order[]

  @@unique([outletId, tableNo])
  @@map("tables")
}

enum TableStatus {
  AVAILABLE
  BOOKED
  OCCUPIED
  MAINTENANCE
}

// TimeSlot model - takeaway time slots per outlet
model TimeSlot {
  id            String   @id @default(uuid())
  outletId      String
  time          String   @db.VarChar(10)
  maxOrders     Int      @default(10)
  currentOrders Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  outlet Outlet  @relation(fields: [outletId], references: [id], onDelete: Cascade)
  orders Order[]

  @@unique([outletId, time])
  @@map("time_slots")
}

// Order model - central reservation records
model Order {
  id              String          @id @default(uuid())
  orderNo         String          @unique @db.VarChar(20)
  outletId        String
  fulfillmentType FulfillmentType

  // Customer info
  customerName  String @db.VarChar(100)
  customerEmail String @db.VarChar(100)
  customerPhone String @db.VarChar(20)

  // Booking details
  bookingDate     DateTime @db.Date
  tableId         String?
  timeSlotId      String?
  paxCount        Int?
  deliveryAddress String?  @db.Text

  // Order items with customizations
  orderItems Json? // Stores array of ordered items with customizations

  // Pricing
  subtotal    Decimal @db.Decimal(10, 2)
  sst         Decimal @db.Decimal(10, 2)
  bookingFee  Decimal @default(1.00) @db.Decimal(10, 2)
  deliveryFee Decimal @default(0) @db.Decimal(10, 2)
  total       Decimal @db.Decimal(10, 2)

  // Status
  status       OrderStatus @default(PENDING)
  notes        String?     @db.Text
  reminderSent Boolean     @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  outlet   Outlet    @relation(fields: [outletId], references: [id])
  table    Table?    @relation(fields: [tableId], references: [id])
  timeSlot TimeSlot? @relation(fields: [timeSlotId], references: [id])
  payment  Payment?

  @@index([bookingDate, status])
  @@index([outletId, bookingDate])
  @@index([customerEmail])
  @@index([status])
  @@map("orders")
}

enum FulfillmentType {
  DINE_IN
  TAKEAWAY
  DELIVERY
}

enum OrderStatus {
  PENDING
  PAID
  CONFIRMED
  COMPLETED
  CANCELLED
}

// Payment model - ToyyibPay transaction tracking
model Payment {
  id            String        @id @default(uuid())
  orderId       String        @unique
  billCode      String?       @db.VarChar(50)
  transactionId String?       @db.VarChar(100)
  amount        Decimal       @db.Decimal(10, 2)
  status        PaymentStatus @default(PENDING)
  paidAt        DateTime?
  callbackData  Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([billCode])
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
}

// Admin model - admin users
model Admin {
  id        String    @id @default(uuid())
  email     String    @unique @db.VarChar(100)
  password  String    @db.VarChar(255)
  name      String    @db.VarChar(100)
  role      AdminRole @default(OUTLET)
  outletId  String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  outlet Outlet? @relation(fields: [outletId], references: [id])

  @@map("admins")
}

enum AdminRole {
  MASTER
  OUTLET
}

// Setting model - system configuration
model Setting {
  id        String   @id @default(uuid())
  key       String   @unique @db.VarChar(50)
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}

// Customer model - registered customers for faster checkout
model Customer {
  id        String   @id @default(uuid())
  email     String   @unique @db.VarChar(100)
  password  String   @db.VarChar(255)
  name      String   @db.VarChar(100)
  phone     String   @unique @db.VarChar(20)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customers")
}

// Category model - menu categories
model Category {
  id           String     @id @default(uuid())
  name         String     @unique @db.VarChar(50) // e.g. "Set Menu", "Ala Carte", "Drinks"
  slug         String     @unique @db.VarChar(50) // URL-friendly version e.g. "set-menu"
  displayOrder Int        @default(0) // For sorting categories
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  menuItems    MenuItem[] // One category has many menu items

  @@map("categories")
}

// MenuItem model - dynamic menu items
model MenuItem {
  id                   String   @id @default(uuid())
  name                 String   @db.VarChar(100)
  description          String   @db.VarChar(255)
  price                Decimal  @db.Decimal(10, 2)
  image                String   @db.VarChar(255) // URL or path
  categoryId           String // Foreign key to Category
  category             Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  ingredients          String?  @db.Text // JSON string or comma-separated
  freeItem             String?  @db.VarChar(100)
  isFeatured           Boolean  @default(false)
  isActive             Boolean  @default(true)
  rating               Decimal  @default(5.0) @db.Decimal(2, 1)
  reviewCount          Int      @default(0)
  hasCustomization     Boolean  @default(false)
  customizationOptions Json? // Stores customization config (ayamType, sambalLevel, drink)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([categoryId])
  @@map("menu_items")
}

// Review model - for celebrity testimonials and customer feedback
model Review {
  id         String   @id @default(uuid())
  name       String   @db.VarChar(100)
  role       String?  @db.VarChar(50) // e.g. "Influencer", "Artist"
  content    String   @db.Text
  image      String?  @db.VarChar(255) // Avatar
  rating     Int      @default(5)
  isFeatured Boolean  @default(false) // To assist in filtering for the landing page
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("reviews")
}

// Promotion model - promotional popups/banners
model Promotion {
  id          String    @id @default(uuid())
  title       String    @db.VarChar(100)
  description String?   @db.Text
  image       String?   @db.VarChar(255)
  buttonText  String?   @db.VarChar(50)
  buttonLink  String?   @db.VarChar(255)
  isActive    Boolean   @default(true)
  startDate   DateTime? @db.Date
  endDate     DateTime? @db.Date
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("promotions")
}
